{"net":{"http_server_properties":{"broken_alternative_services":[{"broken_count":12,"host":"teams.microsoft.com","isolation":[],"port":443,"protocol_str":"quic"}],"servers":[{"isolation":[],"server":"https://ocws.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://assignments.onenote.com","supports_spdy":true},{"isolation":[],"server":"https://itbdsti.sharepoint.com","supports_spdy":true},{"isolation":[],"server":"https://itbdsti-my.sharepoint.com","supports_spdy":true},{"isolation":[],"server":"https://spo.nel.measure.office.net","supports_spdy":true},{"isolation":[],"server":"https://southeastasia1-mediap.svc.ms","supports_spdy":true},{"isolation":[],"server":"https://www.odwebp.svc.ms","supports_spdy":true},{"isolation":[],"server":"https://apac.presence.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://noam.presence.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://teams.live.com","supports_spdy":true},{"isolation":[],"server":"https://whiteboard.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://urlp.asm.skype.com","supports_spdy":true},{"isolation":[],"server":"https://wordonline.nel.measure.office.net","supports_spdy":true},{"isolation":[],"server":"https://word-edit.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://psg1-collabhubrtc.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://spoppe-b.azureedge.net","supports_spdy":true},{"isolation":[],"server":"https://lpcres.delve.office.com","supports_spdy":true},{"isolation":[],"server":"https://c1h-word-edit-15.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000074.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000051.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000059.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000006.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000002.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://wa104381125.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000085.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://fa000000029.resources.office.net","supports_spdy":true},{"isolation":[],"server":"https://nleditor.osi.office.net","supports_spdy":true},{"isolation":[],"server":"https://mrodevicemgr.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://collabrtc.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://augmentation.osi.office.net","supports_spdy":true},{"isolation":[],"server":"https://officeclient.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://reflect.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://eduinsights.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://chatsvcagg.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://japanwest-prod.notifications.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://api.teams.skype.com","supports_spdy":true},{"isolation":[],"server":"https://business.bing.com","supports_spdy":true},{"isolation":[],"server":"https://modernb.akamai.odsp.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://japaneast1-mediap.svc.ms","supports_spdy":true},{"isolation":[],"server":"https://static2.sharepointonline.com","supports_spdy":true},{"isolation":[],"server":"https://accounts.google.com","supports_spdy":true},{"isolation":[],"server":"https://apis.google.com","supports_spdy":true},{"isolation":[],"server":"https://ssl.gstatic.com","supports_spdy":true},{"isolation":[],"server":"https://modern.akamai.odsp.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://bot-framework.azureedge.net","supports_spdy":true},{"isolation":[],"server":"https://api.cortana.ai","supports_spdy":true},{"isolation":[],"server":"https://sfapc.loki.delve.office.com","supports_spdy":true},{"isolation":[],"server":"https://educdn.azureedge.net","supports_spdy":true},{"isolation":[],"server":"https://eastasia1-mediap.svc.ms","supports_spdy":true},{"isolation":[],"server":"https://centralindia-prod.notifications.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://redirector.gvt1.com","supports_spdy":true},{"isolation":[],"server":"https://urlp.sfbassets.com","supports_spdy":true},{"isolation":[],"server":"https://cxcs.microsoft.net","supports_spdy":true},{"isolation":[],"server":"https://pods.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://eastasia-prod-2.notifications.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://eduta-prod.trafficmanager.net","supports_spdy":true},{"isolation":[],"server":"https://config.edge.skype.com","supports_spdy":true},{"isolation":[],"server":"https://app.whiteboard.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://roaming.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://c.bing.com","supports_spdy":true},{"isolation":[],"server":"https://c.office.com","supports_spdy":true},{"isolation":[],"server":"https://cdn.forms.office.net","supports_spdy":true},{"isolation":[],"server":"https://forms.office.com","supports_spdy":true},{"isolation":[],"server":"https://assets.careercoach.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://assets.onestore.ms","supports_spdy":true},{"isolation":[],"server":"https://amsglob0cdnstream14.azureedge.net","supports_spdy":true},{"isolation":[],"server":"https://amsglob0cdnstream13.azureedge.net","supports_spdy":true},{"isolation":[],"server":"https://api.microsoftstream.com","supports_spdy":true},{"isolation":[],"server":"https://web.microsoftstream.com","supports_spdy":true},{"isolation":[],"server":"https://aase-1.api.microsoftstream.com","supports_spdy":true},{"isolation":[],"server":"https://aase-1.notification.api.microsoftstream.com","supports_spdy":true},{"isolation":[],"server":"https://csp.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://spoprod-a.akamaihd.net","supports_spdy":true},{"isolation":[],"server":"https://statics.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://res-2.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://www.onenote.com","supports_spdy":true},{"isolation":[],"server":"https://res.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://odc.officeapps.live.com","supports_spdy":true},{"isolation":[],"server":"https://teams.nel.measure.office.net","supports_spdy":true},{"isolation":[],"server":"https://appsuggestions.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://apc.loki.delve.office.com","supports_spdy":true},{"isolation":[],"server":"https://media.licdn.com","supports_spdy":true},{"isolation":[],"server":"https://apac.ng.msg.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://api.userstore.skype.com","supports_spdy":true},{"isolation":[],"server":"https://statics.teams.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://cxcs.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://loki.delve.office.com","supports_spdy":true},{"isolation":[],"server":"https://res-1.cdn.office.net","supports_spdy":true},{"isolation":[],"server":"https://s-ring.msedge.net","supports_spdy":true},{"isolation":[],"server":"https://fpc.msedge.net","supports_spdy":true},{"alternative_service":[{"advertised_alpns":["h3"],"expiration":"13318901465198236","port":443,"protocol_str":"quic"},{"advertised_alpns":["h3-29"],"expiration":"13318901465198237","port":443,"protocol_str":"quic"}],"isolation":[],"network_stats":{"srtt":28447},"server":"https://outlook.office.com","supports_spdy":true},{"isolation":[],"server":"https://teams.events.data.microsoft.com","supports_spdy":true},{"alternative_service":[{"advertised_alpns":["h3"],"expiration":"13318901490055262","port":443,"protocol_str":"quic"},{"advertised_alpns":["h3-29"],"expiration":"13318901490055263","port":443,"protocol_str":"quic"}],"isolation":[],"network_stats":{"srtt":46774},"server":"https://substrate.office.com","supports_spdy":true},{"isolation":[],"server":"https://browser.pipe.aria.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://config.teams.microsoft.com","supports_spdy":true},{"isolation":[],"server":"https://presence.teams.microsoft.com","supports_spdy":true},{"alternative_service":[{"advertised_alpns":["h3"],"expiration":"13321411880986877","port":443,"protocol_str":"quic"},{"advertised_alpns":["h3-29"],"expiration":"13321411880986878","port":443,"protocol_str":"quic"},{"advertised_alpns":["h3-Q050"],"expiration":"13321411880986879","port":443,"protocol_str":"quic"}],"isolation":[],"network_stats":{"srtt":25804},"server":"https://dns.google","supports_spdy":true}],"supports_quic":{"address":"192.168.10.126","used_quic":true},"version":5},"network_qualities":{"CAASABiAgICA+P////8B":"4G","CAESABiAgICA+P////8B":"4G","CAISABiAgICA+P////8B":"4G","CAYSABiAgICA+P////8B":"Offline"}}}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!sync()) {
    DBG_FAIL_MACRO;
    goto fail;
  }

  date = FS_DATE(year, month, day);
  time = FS_TIME(hour, minute, second);
  ms10 = second & 1 ? 100 : 0;

  for (uint8_t is = 0; is <= m_setCount; is++) {
    cache = dirCache(is, FsCache::CACHE_FOR_READ);
    if (!cache) {
      DBG_FAIL_MACRO;
      goto fail;
    }
    switch (cache[0]) {
      case EXFAT_TYPE_FILE:
        df = reinterpret_cast<DirFile_t*>(cache);
        setLe16(df->attributes, m_attributes & FS_ATTRIB_COPY);
        m_vol->dataCacheDirty();
        if (flags & T_ACCESS) {
          setLe16(df->accessTime, time);
          setLe16(df->accessDate, date);
        }
        if (flags & T_CREATE) {
          df->createTimeMs = ms10;
          setLe16(df->createTime, time);
          setLe16(df->createDate, date);
        }
        if (flags & T_WRITE) {
          df->modifyTimeMs = ms10;
          setLe16(df->modifyTime, time);
          setLe16(df->modifyDate, date);
        }
        break;

      case EXFAT_TYPE_STREAM:
        break;

      case EXFAT_TYPE_NAME:
        break;

      default:
        DBG_FAIL_MACRO;
        goto fail;
        break;
    }
    checksum = exFatDirChecksum(cache, checksum);
  }
  df = reinterpret_cast<DirFile_t*>
       (m_vol->dirCache(&m_dirPos, FsCache::CACHE_FOR_WRITE));
  if (!df) {
    DBG_FAIL_MACRO;
    goto fail;
  }
  setLe16(df->setChecksum, checksum);
  if (!m_vol->cacheSync()) {
    DBG_FAIL_MACRO;
    goto fail;
  }
  return true;

 fail:
  return false;
}
//------------------------------------------------------------------------------
bool ExFatFile::truncate() {
  uint32_t toFree;
  // error if not a normal file or read-only
  if (!isWritable()) {
    DBG_FAIL_MACRO;
    goto fail;
  }
  if (m_firstCluster == 0) {
      return true;
  }
  if (isContiguous()) {
    uint32_t nc = 1 + ((m_dataLength - 1) >> m_vol->bytesPerClusterShift());
    if (m_curCluster) {
      toFree = m_curCluster + 1;
      nc -= 1 + m_curCluster - m_firstCluster;
    } else {
      toFree = m_firstCluster;
      m_firstCluster = 0;
    }
    if (nc && !m_vol->bitmapModify(toFree, nc, 0)) {
      DBG_FAIL_MACRO;
      goto fail;
    }
  } else {
    // need to free chain
    if (m_curCluster) {
      toFree = 0;
      int8_t fg = m_vol->fatGet(m_curCluster, &toFree);
      if (fg < 0) {
        DBG_FAIL_MACRO;
        goto fail;
      }
      if (fg) {
        // current cluster is end of chain
        if (!m_vol->fatPut(m_curCluster, EXFAT_EOC)) {
          DBG_FAIL_MACRO;
          goto fail;
        }
      }
    } else {
      toFree = m_firstCluster;
      m_firstCluster = 0;
    }
    if (toFree) {
      if (!m_vol->freeChain(toFree)) {
        DBG_FAIL_MACRO;
        goto fail;
      }
    }
  }
  m_dataLength = m_curPosition;
  m_validLength = m_curPosition;
  m_flags |= FILE_FLAG_DIR_DIRTY;
  return sync();

 fail:
  return false;
}
//------------------------------------------------------------------------------
size_t ExFatFile::write(const void* buf, size_t nbyte) {
  // convert void* to uint8_t*  -  must be before goto statements
  const uint8_t* src = reinterpret_cast<const uint8_t*>(buf);
  uint8_t* cache;
  uint8_t cacheOption;
  uint16_t sectorOffset;
  uint32_t sector;
  uint32_t clusterOffset;

  // number of bytes left to write  -  must be before goto statements
  size_t toWrite = nbyte;
  size_t n;
  // error if not an open file or is read-only
  if (!isWritable()) {
    DBG_FAIL_MACRO;
    goto fail;
  }
  // seek to end of file if append flag
  if ((m_flags & FILE_FLAG_APPEND)) {
    if (!seekSet(m_validLength)) {
      DBG_FAIL_MACRO;
      goto fail;
    }
  }
  while (toWrite) {
    clusterOffset = m_curPosition & m_vol->clusterMask();
    sectorOffset = clusterOffset & m_vol->sectorMask();
    if (clusterOffset == 0) {
      // start of new cluster
      if (m_curCluster != 0) {
        int fg;

        if (isContiguous()) {
          uint32_t lc = m_firstCluster;
          lc += (m_dataLength - 1) >> m_vol->bytesPerClusterShift();
          if (m_curCluster < lc) {
            m_curCluster++;
            fg = 1;
          } else {
            fg = 0;
          }
        } else {
          fg = m_vol->fatGet(m_curCluster, &m_curCluster);
          if (fg < 0) {
            DBG_FAIL_MACRO;
            goto fail;
          }
        }
        if (fg == 0) {
          // add cluster if at end of chain
          if (!addCluster()) {
            DBG_FAIL_MACRO;
            goto fail;
          }
        }
      } else {
        if (m_firstCluster == 0) {
          // allocate first cluster of file
          if (!addCluster()) {
            DBG_FAIL_MACRO;
            goto fail;
          }
          m_firstCluster = m_curCluster;
        } else {
          m_curCluster = m_firstCluster;
        }
      }
    }
    // sector for data write
    sector = m_vol->clusterStartSector(m_curCluster) +
             (clusterOffset >> m_vol->bytesPerSectorShift());

    if (sectorOffset != 0 || toWrite < m_vol->bytesPerSector()) {
      // partial sector - must use cache
      // max space in sector
      n = m_vol->bytesPerSector() - sectorOffset;
      // lesser of space and amount to write
      if (n > toWrite) {
        n = toWrite;
      }

      if (sectorOffset == 0 && m_curPosition >= m_validLength) {
        // start of new sector don't need to read into cache
        cacheOption = FsCache::CACHE_RESERVE_FOR_WRITE;
      } else {
        // rewrite part of sector
        cacheOption = FsCache::CACHE_FOR_WRITE;
      }
      cache = m_vol->dataCachePrepare(sector, cacheOption);
      if (!cache) {
        DBG_FAIL_MACRO;
        goto fail;
      }
      uint8_t* dst = cache + sectorOffset;
      memcpy(dst, src, n);
      if (m_vol->bytesPerSector() == (n + sectorOffset)) {
        // Force write if sector is full - improves large writes.
        if (!m_vol->dataCacheSync()) {
          DBG_FAIL_MACRO;
          goto fail;
        }
      }
#if USE_MULTI_SECTOR_IO
    } else if (toWrite >= 2*m_vol->bytesPerSector()) {
      // use multiple sector write command
      uint32_t ns = toWrite >> m_vol->bytesPerSectorShift();
      // Limit writes to current cluster.
      uint32_t maxNs = m_vol->sectorsPerCluster()
                       - (clusterOffset >> m_vol->bytesPerSectorShift());
      if (ns > maxNs) {
        ns = maxNs;
      }
      n = ns << m_vol->bytesPerSectorShift();
      if (!m_vol->cacheSafeWrite(sector, src, ns)) {
         DBG_FAIL_MACRO;
        goto fail;
      }
#endif  // USE_MULTI_SECTOR_IO
    } else {
      n = m_vol->bytesPerSector();
      if (!m_vol->cacheSafeWrite(sector, src)) {
        DBG_FAIL_MACRO;
        goto fail;
      }
    }
    m_curPosition += n;
    src += n;
    toWrite -= n;
    if (m_curPosition > m_validLength) {
      m_flags |= FILE_FLAG_DIR_DIRTY;
      m_validLength = m_curPosition;
    }
  }
  if (m_curPosition > m_dataLength) {
    m_dataLength = m_curPosition;
    // update fileSize and insure sync will update dir entry
    m_flags |= FILE_FLAG_DIR_DIRTY;
  } else if (FsDateTime::callback) {
    // insure sync will update modified date and time
    m_flags |= FILE_FLAG_DIR_DIRTY;
  }
  return nbyte;

 fail:
  // return for write error
  m_error |= WRITE_ERROR;
  return 0;
}
#endif  // EXFAT_READ_ONLY
